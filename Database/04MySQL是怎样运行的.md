# MySQL是怎样运行的

## 1. 重新认识MySQL

-   启动`MySQL`服务器的进程默认名为`mysqld`，`MySQL`客户端进程默认名为`mysql`。



### 1.1 MySQL的安装和路径

macOS和Linux下MySQL的安装目录是：

```bash
/usr/local/mysql/
```

#### 1.1.1 bin目录下的可执行文件

`MySQL`的安装目录下有一个`bin`目录，存放的是「许多可执行文件」，可以把这个路径设置为环境变量`PATH`。

`PATH`的值表示：<u>当输入一个命令的时候，系统会从这些目录下搜索是否存在我们输入的命令，如果存在就执行目录下的可执行文件。</u>把`MySQL`安装目录下的`bin`目录添加到`PATH`中，就可以直接使用`mysqld`而不是`/usr/local/mysql/mysqld`了。



### 1.2 启动MySQL服务器程序

#### 1.2.1 类UNIX系统中的启动服务器程序

大部分`MySQL`安装目录在`bin`目录下：

**mysqld**

`mysqld`可执行文件代表`MySQL`服务器程序，运行这个文件就可以直接启动一个服务器进程。但是它不常用。

**mysqld_safe**

`mysqld_safe`是一个启动脚本，它会间接调用`mysqld`，同时还启动了另外一个监控进程。这个监控进程在服务器进程挂了的时候，可以帮助重启；同时，它还会将服务器程序的「出错信息」和「其他诊断信息」重定向到某个文件中，产生出错日志。

**mysql.server**

`mysql.server`也是一个启动脚本，它会间接的调用`mysqld_safe`，在调用`mysql.server`时在后面指定`start`参数可以启动服务器程序，使用`stop`参数可以停止服务器

```bash
mysql.server start
mysql.server stop
```

这个`mysql.server`是一个软链接，它实际指向`../support-files/mysql.server`



### 1.3 启动MySQL客户端程序

`bin`目录下有许多客户端程序，例如`mysqladmin`,`mysqldump`,`mysqlcheck`等。也可以使用`mysql`启动：

```bash
mysql -h主机名 -u用户名 -p密码
```

| 参数名 | 含义                                                         |
| ------ | ------------------------------------------------------------ |
| `-h`   | 表示服务器进程所在的计算机的IP地址（也可以是域名），如果是本机可以省略这个参数 |
| `-u`   | 用户名                                                       |
| `-p`   | 密码，注意`-p`和密码之间不能有空白字符，其他参数可以空格也可以不加空格 |

>   需要注意，「只有一个英文字母的参数」成为「短形式的参数」，使用时前面需要加`-`。而`host`,`user`等大于一个字母的参数称为「长形式的参数」，使用时前面加`--`双短划线



### 1.4 客户端和服务器连接的过程

**客户端向服务器发送请求并获得回复的过程本质上是「进程间的通信」，**`MySQL`支持三种通信方式：

#### 1.4.1 TCP/IP

真实环境中，数据库服务器进程和客户端进程可能运行在不同的主机中，它们之间**必须**通过网络来进行通讯。`MySQL`服务器会默认监听`3306`端口。也可以使用`-P`来指明端口号：

```bash
mysqld -P3307
```

客户端默认连接`3306`端口，如果想要连接其他端口，需要加`-P`参数（注意是大写的`P`，小写的`p`是指定密码的）。

#### 1.4.2 命名管道和共享内存



使用共享内存方式进行通信的客户端进程和服务器进程必须在同一台`Windows`主机中。



#### 1.4.3 Unix域套接字文件

如果服务器进程和客户端进程都运行在同一台`类Unix`的机器上，可以使用`Unix域套接字文件`来进行进程间通信。



### 1.5 服务器处理客户端请求

不管客户端和服务器进程采用哪种方式进行通信，最后的效果都是：

-   **客户端进程向服务器进程发送一段文本（MySQL语句）**
-   **服务器进程处理后向客户端发送一段文本（处理结果）**

<img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/12/28/167f4c7b99f87e1c~tplv-t2oaga2asx-zoom-in-crop-mark:3024:0:0:0.image" style="zoom:100%;" />

服务器程序处理来自客户端的查询请求，大致需要经过三个部分：

1.   **连接管理**
2.   **解析与优化**
3.   **存储引擎**

#### 1.5.1 连接管理

客户端进程可以采用多种方式向服务器进程建立连接，每一个客户端进程连接到服务器进程时，服务器进程都会创建一个线程来处理这个客户端的交互，`MySQL`服务器可能有「类似线程池」的设计，来避免频繁创建和销毁线程。如果连接太多，线程也会很多，会影响系统性能。

当客户端进程发起连接的时候，需要携带「主机信息」、「用户名」、「密码」，服务器会对这些信息进行认证，如果客户端和服务器进程不在同一台计算机上，还可以采用使用了`SSL`（安全套接字）的网络连接来进行通信，来保证数据传输的安全性。

当连接建立后，与该客户端关联的服务器线程会一直等待客户端发送过来的请求，`MySQL`服务器接收到的请求只是一个文本消息，该文本消息还要经过各种处理。

解析与优化中比较重要的就是：

-   查询缓存
-   语法解析
-   查询优化

#### 1.5.2 解析与优化之查询缓存

`MySQL`会将刚刚处理过的查询请求和结果「**缓存**」起来，如果有相同的请求，直接从缓存中查询结果就好了。**这个「查询缓存」可以在不同的客户端之间共享。**

但是，如果两个查询请求在任何字符上的不同（如：空格、注释、大小写），都会导致缓存不命中。另外，如果查询请求中包含「某些系统函数」、「用户自定义变量和函数」、「一些系统表」（如：`mysql`,`information_schema`,`performance_schema`数据库中的表），那么这个请求就不会被缓存。

-   例如系统函数`NOW`，两次调用的结果不同，所以不能用缓存。



**缓存失效：**MySQL的缓存系统会监测涉及到的每张表，只要该表的结构或者数据被修改，例如使用了`INSERT`,`UPADTE`等语句，那么这个表**所有的**高速缓存查询都将变为无效，并从高速缓存中删除。

>   Tips：
>
>   查询缓存会有维护的开销，从MySQL5.7.20开始不推荐使用查询缓存，并在MySQL8.0中删除



#### 1.5.3 解析与优化之语法解析

如果查询缓存没有命中，那么就需要进入正式的查询阶段了，本质上是一个编译过程。

#### 1.5.4 解析与优化之查询优化

自己写的`MySQL`语句执行起来效率可能不是很高，`MySQL`的优化程序会对`MySQL`语句进行一些优化，可以使用`EXPLAIN`语句来查看某个语句的执行计划。



#### 1.5.5 存储引擎

`MySQL`服务器把数据的存储和提取操作都「封装」到了一个叫「存储引擎」的模块中。所谓「表格」，是由一行一行的记录组成的，但这只是一个**逻辑上的概念**，物理上怎么表示记录，怎么从表中读取数据，怎么把数据写入具体的物理存储器上，这都是「存储引擎」负责的事情，`MySQL`提供了多种「存储引擎」，不同「存储引擎」管理的表具体的存储结构可能不同，采用的存储算法也不同。

>   在以前，「存储引擎」被称为「表处理器」，它的功能就是接收上层传下来的指令，如何对表中的数据进行提取或写入操作。

为了管理方便，我们把「连接管理」、「查询缓存」、「语法解析」、「查询优化」这些不涉及真实数据存储的功能划分为`MySQL server`的功能，把真实存取数据的功能划分为「存储引擎」的功能。各种不同的存储引擎向上层的`MySQL server`层提供**统一的调用接口**（也就是存储引擎API），包含了几十个底层函数，例如「读取索引第一条内容」、「读取索引下一条内容」、「插入记录」等。

所以，在`MySQL server`完成了查询优化后，只需要按照生成的「执行计划」调用底层「存储引擎」提供的API，获取到数据后返回给客户端就好了。



### 1.6 常用存储引擎

`MySQL`有非常多的存储引擎：

| 存储引擎 | 简述                                   |
| -------- | -------------------------------------- |
| ARCHIVE  | 用于数据存档（行被插入后不能再被修改） |
| BLACKHLE | 丢弃写操作，读操作会返回空内容         |
| CSV      | 存储数据时，用`,`分割各个数据项        |
| InnoDB   | 具备外键支持功能的事务存储引擎         |
| MEMORY   | 置于内存的表                           |
| MyISAM   | 主要的非事务处理存储引擎               |

还有很多存储引擎。但是最常用的是`InnoDB`和`MyISAM`，偶尔会提到`Memory`。其中`InnoDB`是`MySQL`的默认存储引擎。



#### 1.6.1 查看当前服务器程序支持的存储引擎

可以使用`SHOW ENGINES;`来查看当前服务器支持的存储引擎

```bash
mysql> SHOW ENGINES;
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| Engine             | Support | Comment                                                        | Transactions | XA   | Savepoints |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
| ARCHIVE            | YES     | Archive storage engine                                         | NO           | NO   | NO         |
| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears) | NO           | NO   | NO         |
| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                          | NO           | NO   | NO         |
| FEDERATED          | NO      | Federated MySQL storage engine                                 | NULL         | NULL | NULL       |
| MyISAM             | YES     | MyISAM storage engine                                          | NO           | NO   | NO         |
| PERFORMANCE_SCHEMA | YES     | Performance Schema                                             | NO           | NO   | NO         |
| InnoDB             | DEFAULT | Supports transactions, row-level locking, and foreign keys     | YES          | YES  | YES        |
| MEMORY             | YES     | Hash based, stored in memory, useful for temporary tables      | NO           | NO   | NO         |
| CSV                | YES     | CSV storage engine                                             | NO           | NO   | NO         |
+--------------------+---------+----------------------------------------------------------------+--------------+------+------------+
9 rows in set (0.01 sec)
```

其中，`Transactions`代表是否支持事物处理，`XA`代表是否支持「分布式事务」，`Savepoints`代表是否支持部分事务回滚。



#### 设置表的存储引擎

1.   创建表时指定存储引擎：

     ```sql
     CREATE TABLE 表名
     (
     	建表语句;
     ) ENGINE = XXX;
     ```

     其中XXX代表存储引擎，可以是`MyISAM`等。

2.   修改表的存储引擎：

     ```sql
     ALTER TABLE 表名 ENGINE = 存储引擎名称;
     ```



## 2. 启动选项和系统变量

`MySQL`的客户端和服务器有很多设置项，例如对于`MySQL`服务器，可以指定「允许同时联入的客户端数量」、「客户端和服务器的通信方式」、「表的默认存储引擎」、「查询缓存的大小」等。对于`MySQL`客户端，可以设置「需要连接的服务器程序所在主机的主机名或IP地址」、「用户名和用户密码」等信息。

这些设置一般都有默认值，也可以在启动时放在命令行中指定，也可以放在配置文件中指定。



### 2.1 在命令行上使用选项

在服务器端使用`skip-networking`启动选项，可以禁止客户端使用`TCP/IP`网络进行通信：

```bash
mysqld --skip-networking
```

>   `skip-networking`和`skip_networking`是等价的。



在服务端使用`--default-storage-engine=XX`可以在启动时指定默认的存储引擎：

```sql
mysqld --default-storage-engine=MyISAM
```

>   注意，`=`左右两边不可以有空格。

### 2.2 在配置文件中使用选项

我们可以把需要设置的启动选项写在一个配置文件中，这样只需要配置一次，不用每次都显式的把启动选项写在命令行中，所以推荐使用这种方式。



#### 2.2.1 配置文件的路径

在类UNIX操作系统中，MySQL会按照下列路径来寻找配置文件：

| 路径名                | 备注                                 |
| --------------------- | ------------------------------------ |
| `/etc/my.cnf`         |                                      |
| `/etc/mysql/my.cnf`   |                                      |
| `SYSCONFDIR/my.cnf`   |                                      |
| `$MYSQL_HOME/my.cnf`  | 特定于服务器的选项（仅限于服务器）   |
| `defaults-extra-file` | 命令行指定的额外配置文件路径         |
| `~/.my.cnf`           | 用户特定选项                         |
| `~/.mylogin.cnf`      | 用户特定的登陆路径选项（仅限客户端） |

-   `SYSCONFDIR`表示在使用`CMake`构建`MySQL`时使用`SYSCONFDIR`选项指定的目录。默认情况下，这是位于编译安装目录下的`etc`目录

-   `MYSQL_HOME`是一个环境变量，可以自己设置，这个「变量的值」代表一个路径。这个路径下的`my.cnf`只能放关于服务器启动相关的选项。没有特殊说明的配置文件既能存放服务器相关的选项也能存放客户端相关的选项。

    如果使用`mysqld_safe`启动服务器程序，这个环境变量的值将被设置为`MySQL`的安装目录。

-   我们在启动程序时可以通过指定`defaults-extra-file`参数的值来添加额外的配置文件路径。（extra代表「额外」的意思）

-   `.mylogin.cnf`有些特殊，它不是一个纯文本文件（其他的配置文件都是纯文本文件），而是使用`mysql_config_editor`实用程序创建的加密文件。文件中只能包含一些用于启动客户端软件时连接服务器的一些选项，包括 `host`、`user`、`password`、`port`和 `socket`。而且它只能被客户端程序所使用。

    有专门的语法来修改这个文件。

#### 2.2.2 配置文件的内容

```ini
[server]
option1
option2 = value
(具体的启动选项...)

[mysqld]
(具体的启动选项...)

[mysqld_safe]
(具体的启动选项...)

[client]
(具体的启动选项...)

[mysql]
(具体的启动选项...)

[mysqladmin]
(具体的启动选项...)
```

配置文件中的启动项被划分成若干个组，每个组有一个组名，用`[]`中括号括起来，例如上面的配置文件就定义了很多个组，组名分别是：`server`,`mysqld`,`mysqld_safe`等。

`option1`代表没有赋值，`option2`代表可以指定，同时`=`左右可以出现空格。

配置文件中不同的选项组，是给不同的启动命令使用的：

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230429152458316.png" alt="image-20230429152458316" style="zoom:50%;" />

如果在`/etc/mysql/my.cnf`这个配置文件中写：

```ini
[server]
skip-networking
default-storage-engine=MyISAM
```

重启MySQL后，不能用TCP/IP连接，远程连接连不上了；同时默认的存储引擎变为`MyISAM`。

我们可以在选项组的名称后加上特定的`MySQL`版本号，比如对于`[mysqld]`选项组来说，我们可以定义一个`[mysqld-5.7]`的选项组，它的含义和`[mysqld]`一样，只不过只有版本号为`5.7`的`mysqld`程序才能使用这个选项组中的选项。



#### 2.2.3 配置文件的优先级

`MySQL`会按照前面的表依次读取各个配置文件，如果不存在则忽略，同时后面的配置会**覆盖**前面的配置。

同时，同一个文件中的同一个组，如果有同样的配置项，也是以「最后一个出现」的启动选项为准。



如果不想让`MySQL`到默认的路径下搜索配置文件，可以在命令行指定`defaults-file`选项：

```bash
mysqld --defaults-file=/tmp/myconfig.txt
```

那么程序启动的时候，**只会**在`/tmp/myconfig.txt`路径下搜索配置文件。很显然，这个启动选项只能在命令行中使用。

如果配置文件和命令行冲突，以命令行为准。

### 2.3 系统变量

#### 2.3.1 系统变量简介

`MySQL`服务器运行的时候会用到许多影响程序行为的变量，它们被称为「`MySQL`系统变量」，比如：

-   `max_connections`：表示允许同时连入的客户端数量
-   `default_storage_engine`：表示默认存储引擎
-   `query_cache_size`：表示查询缓存大小
-   等等，共有几百条

每个系统变量都有默认值，也可以使用「命令行」或「配置文件」的选项在启动的时候修改一些系统变量。大多数的系统变量的值也可以在程序运行的过程中修改，而不需要停止并重新启动它。



#### 2.3.2 查看系统变量

查看`MySQL`服务器支持的系统变量和当前的值：

```mysql
show variables [like 匹配的模式];
```

`[]`中括号代表中间的内容可有可无。可以使用`like`的过滤条件来查看系统变量的值。例如：

```sql
mysql> show variables like 'default_storage_engine';
+------------------------+--------+
| Variable_name          | Value  |
+------------------------+--------+
| default_storage_engine | MyISAM |
+------------------------+--------+
1 row in set (0.01 sec)

mysql> show variables like 'max_connections';
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 151   |
+-----------------+-------+
1 row in set (0.00 sec)
```

-   当前默认存储引擎为：MyISAM
-   当前最多允许151条客户端连接

也可以使用通配符模糊查询：

```sql
show variables like 'default%';
```



#### 2.3.3 设置系统变量

大部分的「系统变量」可以使用命令行和配置文件设置。需要注意，对于启动选项来说`_`和`-`是一样的，但是对应的系统变量单词必须使用`_`下划线，所以可以统一使用`_`。



**服务器程序运行过程中设置：**

大部分的系统变量的值可以在服务器程序运行的时候动态修改，而无需重启服务器，但是系统变量有「作用范围」之分。



**设置不同范围的系统变量：**

多个客户端程序可以同时连接到同一个服务器程序。如果对于同一个系统变量，我们希望让不同的客户端有不同的值，这样使用时很方便，但是每个客户端都私有一份系统变量会存在两个问题：

-   有一些系统变量不是针对单个客户端的，例如`max_connections`最大客户端连接数量 和 `query_cache_size`最大缓存大小，这样公共的系统变量让某个客户端私有并不合适。
-   一个新连接到服务器的客户端对应的系统变量的值如何设置。

所以，`MySQL`提出了「系统变量」的「作用范围」的概念，具体来说，「作用范围」分为：

-   `GLOBAL`：全局变量，影响服务器的整体操作
-   `SESSION`：会话变量，影响某个客户端连接的操作。（`SESSION`有个别名叫：`LOCAL`）

在服务器启动时，会将每个全局变量初始化为默认值（可以通过命令行和配置文件修改）。同时，服务器还为每个连接的客户端维护一组「会话变量」，客户端的会话变量在连接的时候使用「相应的全局变量」的当前值初始化。

通过启动选项设置的系统变量的作用范围都是`GLOBAL`的，也就是对所有客户端都有效。如果客户端想在服务器运行期间修改系统变量，可以使用：

```sql
set [GLOBAL|SESSION] 系统变量名 = 值;
```

如果省略作用范围，默认的作用范围就是`SESSION`。

如果想把「作用范围为`GLOBAL`的系统变量`default_storage_engine`」的值修改为`MyISAM`，也就是让之后连接到服务器的客户端都用`MyISAM`作为默认的存储引擎，可以用：

```sql
set global default_storage_engine = MyISAM;
#或者
set @@global default_storage_engine = MyISAM;
```

注意修改某个系统变量在`GLOBAL`作用范围的值，不会影响当前已经连入的客户端，只会影响新联入的客户端。

如果只想对本客户端生效，可以使用：

```sql
set session default_storage_engine = MyISAM;
#或者
set @@session default_storage_engine = MyISAM;
#或者
set default_storage_engine = MyISAM;
```



#### 2.3.4 查看不同作用范围的系统变量

`show variables`默认查看的是「`SESSION`作用范围的系统变量」。

如果想加上「作用范围」，可以使用：

```sql
show [global|session] variables [like 匹配模式];
```



#### 2.3.5 注意事项

-   并不是所有的系统变量都有`GLOBAL`和`SESSION`的作用范围：
    -   例如`max_connections`表示服务器最多支持多少个客户端同时连接，只有`GLOBAL`范围
    -   `insert_id`只有`SESSION`的作用范围，它表示对某个包含`AUTO_INCREMENT`的列进行插入时，该列初始的值。
    -   大多数系统变量都有`GLOBAL`和`SESSION`的作用范围
-   有些系统变量是只读的，不能设置值：
    -   例如`version`表示当前`MySQL`的版本，它不能被修改。

### 2.4 状态变量

`MySQL`服务器进程还维护了许多关于程序运行状态的变量，用来让用户更好地了解服务器程序的运行情况，这些变量被称为「**状态变量**」，例如：

-   `Threads_connected`表示当前有多少客户端与服务器建立了连接
-   `Handler_update`表示已经更新了多少行记录
-   等等

「状态变量」只能被服务器程序设置，不能自己修改，与「系统变量」类似，「状态变量」也有`GLOBAL`和`SESSION`两种作用范围，所以查看「状态变量」的语句可以这么写：

```sql
show [global|session] status [like 匹配模式];
```

默认显示`SESSION`的范围，例如：

```sql
mysql> show status like 'thread%';
+-------------------+-------+
| Variable_name     | Value |
+-------------------+-------+
| Threads_cached    | 0     |
| Threads_connected | 2     |
| Threads_created   | 2     |
| Threads_running   | 1     |
+-------------------+-------+
4 rows in set (0.00 sec)
```



## 3. 字符集和比较规则

