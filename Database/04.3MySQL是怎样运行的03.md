# MySQL 是怎样运行的 03

## 13. InnoDB 统计数据是如何收集的

「查询成本」经常用到一些统计数据，也可以通过`show table status`查看表的统计数据，通过`show index`可以查看关于索引的统计数据。

那么，这些统计数据是怎么来的呢？

### 13.1 两种不同的统计数据存储方式

`InnoDB`提供了两种存储统计数据的方式：

-   永久性的统计数据

    这种统计数据存储在磁盘上

-   非永久性的统计数据

    这种统计数据存储在内存中，重启就没了，在某些场景下才会重新收集这些统计数据

系统变量`innodb_stats_persistent`可以控制采用哪种方式去存储统计数据，在`MySQL 5.6.6`之前，默认是`OFF`，也就是 InnoDB 的统计数据默认存储到内存中，之后版本中这个变量的值为`ON`，也就是统计数据默认存储到磁盘中。

InnoDB 默认以「表」为单位来收集和存储统计数据的，也就是说我们可以把某些表的统计数据（以及该表的索引的统计数据）存储在磁盘上，把另一些表的统计数据存储在内存中，这个设置可以在创建和修改表的时候通过指定`stats_persistent`属性来指明该表的统计数据的存储方式：

```sql
create table 表名(...) Engine=InnoDB, stats_persistent = (1|0);

alter table 表名 engine=InnoDB, stats_persistent = (1|0);
```

`stats_persistent`为 1 表示存储在磁盘上。





当我们选择把某个表以及该表的索引的统计数据放到磁盘上时，实际上是把这些统计数据存储在两个表里：

```sql
show tables from mysql like 'innodb%';
```

| Tables\_in\_mysql \(innodb%\) |
| :---------------------------- |
| innodb\_index\_stats          |
| innodb\_table\_stats          |

这两个表位于`mysql`系统数据库下面，其中：

-   `innodb_table_stats`存储了关于表的统计数据，每一条记录对应着一个表的统计数据
-   `innodb_index_stats`存储了关于索引的统计数据，每一条记录对应着一个索引的一个统计项的统计数据。



### 13.2 innodb_table_stats

这个表的主键是`(database_name, table_name)`，也就是每一条代表一个表的统计信息。

```sql
select * from mysql.innodb_table_stats;
```



| database\_name   | table\_name         | last\_update        | n\_rows | clustered\_index\_size | sum\_of\_other\_index\_sizes |
| :--------------- | :------------------ | :------------------ | :------ | :--------------------- | :--------------------------- |
| innodb\_demo\_db | single\_table       | 2023-05-07 16:19:35 | 3495    | 23                     | 28                           |
| innodb\_demo\_db | student             | 2023-05-13 22:42:52 | 2       | 1                      | 0                            |
| innodb\_demo\_db | t1                  | 2023-05-13 20:46:21 | 3       | 1                      | 0                            |
| innodb\_demo\_db | t2                  | 2023-05-13 20:46:21 | 3       | 1                      | 0                            |
| innodb\_demo\_db | varchar\_size\_demo | 2023-04-30 16:55:55 | 0       | 1                      | 0                            |
| mysql            | component           | 2023-03-14 15:08:13 | 0       | 1                      | 0                            |
| sys              | sys\_config         | 2023-03-14 15:08:14 | 6       | 1                      | 0                            |

以`single_table`表为例，几个重要的统计信息项的值如下：

-   `n_rows`的值是`3495`，代表表中大约有`3495`条记录，这个值是个估计值
-   `clustered_index_size`的值是`23`，表示`single_table`的聚簇索引占用 23 个页面，这个值也是一个估计值
-   `sum_of_other_index_sizes`的值是`28`，表示`single_table`表其他索引一共占用`28`个页面，这个值也是一个估计值



#### 13.2.1 n_rows 统计项的收集

一个问题：为什么`n_rows`这个统计项是估计值呢？ InnoDB 统计`n_rows`的方式如下：

-   按照一定算法（并不是完全随机）选取几个叶子节点页面，计算每个页面中主键值记录数量，然后计算平均每个页面中主键值的记录数量 乘以 全部叶子节点数量就是该表的`n_rows`的值。

可以看出`n_rows`值的精确与否取决于统计时采样的页面数量，MySQL 甚至提供了一个`innodb_stats_persistent_sample_pages`的系统变量来控制采样的页面数量，这个值越大`n_rows`的值越精确，但是统计时间也越久，默认是`20`。



#### 13.2.2 clustered_index_size和sum_of_other_index_size统计项的收集

