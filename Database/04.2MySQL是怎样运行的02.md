# MySQL是怎样运行的02

## 08. MySQL的数据目录

### 8.1 数据库和文件系统的关系

类似于`InnoDB`和`MyISAM`这样的存储引擎都是把表存在磁盘上的，而操作系统用来管理磁盘的是`文件系统`。所以：像 **InnoDB** 、 **MyISAM** 这样的存储引擎都是把表存储在文件系统上的。当我们想读取数据的时候，这些存储引擎会从文件系统中把数据读出来返回给我们，当我们想写入数据的时候，这些存储引擎会把这些数据又写回文件系统。



### 8.2 MySQL数据目录

MySQL服务器程序在启动时会到文件系统的某个目录下加载一些文件，之后在运行过程中产生的数据也会存储到这个目录下的某些文件中，这个目录被称为`数据目录`。

#### 8.2.1 数据目录和安装目录的区别



#### 8.2.2 确定MySQL中的数据目录

使用:

```sql
show variables like 'datadir';
```

查看`数据目录`，在我的电脑（Mac）上为`/usr/local/mysql/data/`，而在Linux服务器这个目录为`/usr/local/mysql/data/`。



### 8.3 数据目录的结构

MySQL在运行的过程中，会产生很多数据，例如：创建的数据库、表、视图和触发器，这些被称为「用户数据」。除此之外，MySQL也会创建一些其他的额外数据。



#### 8.3.1 数据库在文件系统中的表示

每个数据库都对应数据目录下的一个子目录（文件夹），每当我们新建一个数据库，MySQL会：

1.   在`数据目录`下创建一个和数据库同名的子目录（文件夹）
2.   在这个子目录下创建一个名为`db.opt`文件，这个文件包含了该数据的各种属性，例如字符集和比较规则等。

查看数据目录：

```
-rw-r-----. 1 root mysql  27K 4月  30 15:04 aliyun.err
-rw-r-----. 1 root mysql    5 4月  29 15:18 aliyun.pid
-rw-r-----. 1 root mysql   56 1月   6 01:11 auto.cnf
-rw-------. 1 root mysql 1.7K 1月   6 01:11 ca-key.pem
-rw-r--r--. 1 root mysql 1.1K 1月   6 01:11 ca.pem
-rw-r--r--. 1 root mysql 1.1K 1月   6 01:11 client-cert.pem
-rw-------. 1 root mysql 1.7K 1月   6 01:11 client-key.pem
-rw-r-----. 1 root mysql  286 4月  29 15:18 ib_buffer_pool
-rw-r-----. 1 root mysql  12M 4月  29 15:18 ibdata1
-rw-r-----. 1 root mysql  48M 4月  29 15:18 ib_logfile0
-rw-r-----. 1 root mysql  48M 1月   6 01:11 ib_logfile1
-rw-r-----. 1 root mysql  12M 4月  29 15:18 ibtmp1
-rw-r-----. 1 root mysql  12K 1月  22 21:32 iz2ze04i2j4qfxax1se5xvz.err
-rw-r-----. 1 root mysql  11K 1月  15 16:11 iZ2ze04i2j4qfxax1se5xvZ.err
-rw-r-----. 1 root mysql    6 1月   6 01:14 iZ2ze04i2j4qfxax1se5xvZ.pid
drwxr-x---. 2 root mysql 4.0K 1月   6 01:11 mysql
drwxr-x---. 2 root mysql 4.0K 1月   6 01:11 performance_schema
-rw-------. 1 root mysql 1.7K 1月   6 01:11 private_key.pem
-rw-r--r--. 1 root mysql  452 1月   6 01:11 public_key.pem
-rw-r--r--. 1 root mysql 1.1K 1月   6 01:11 server-cert.pem
-rw-------. 1 root mysql 1.7K 1月   6 01:11 server-key.pem
drwxr-x---. 2 root mysql  12K 1月   6 01:11 sys
drwxr-x---. 2 root mysql 4.0K 1月   6 01:22 yourdb
```

这个数据目录下文件和子目录比较多，除了`information_schema`这个系统数据库外，其他的数据库在`数据目录`下都有对应的子目录。

#### 8.3.2 表在文件系统中的定义

数据都是以「记录」的形式插入到表中的，每个表的信息可以分为两种：

-   表结构的定义，用二进制文件`表名.frm`表示
-   表中的数据，InnoDB和MyISAM保存方式不同



#### 8.3.3 InnoDB存储表数据的方式



**InnoDB中：**

-   使用`页`为基本单位来管理存储空间，默认`页`大小为16KB
-   每个索引都对应一棵B+树，该B+树的每个节点都是一个数据页，这些数据页之间是用「双向链表」连接的
-   聚簇索引的叶子结点存储了完整的用户数据，也就是「索引即数据，数据即索引」

为了管理这些「页」，InnoDB中提出了一个`表空间`（也叫`文件空间`)的概念，「表空间」是一个抽象的概念，它可以对应文件系统上一个或多个真实文件（不同表空间对应的文件数量可能不同）。每一个「表空间」可以被划分为很多个「页」，表数据就存放在某个「表空间」下的某些页中。

表空间有几种不同的类型：

##### 系统表空间（system tablespace）

所谓「系统表空间」可以对应文件系统上一个或多个实际的文件，默认情况下，InnoDB会在「数据目录」下创建一个名为`ibdata1`大小为12M的文件，这个文件就是对应的「系统表空间」在文件系统上的表示，这个文件是「自扩展文件」，当不够用的时候它会自己增加文件大小。

如果像让系统表空间对应系统文件上多个实际文件，可以修改配置文件：

```ini
[server]
innodb_data_filepath=data1:512M;data2:521M:autoextend
```

这样就会有两个512M的文件作为系统表空间，其中`autoextend`表示这两个文件如果不够用会自动扩展`data2`文件的大小。

在MySQL服务器中，系统表空间只有一份，从MySQL5.5.7～MySQL5.6.6之间的各个版本中，我们表中的数据都会被默认存储到这个「系统表空间」。

##### 独立表空间（file-per-table tablespace）

在MySQL5.6.6之后的版本中，InnoDB并不会默认的把各个表的数据存储到系统表空间中，而是为每一个表建立一个独立表空间，也就是说我们创建了多少个表，就有多少个独立表空间。

同时这个表示该「独立表空间」的文件在「该表所属数据库对应的子目录」下，文件名和表名相同，后缀为`.ibd`，例如：`表名.idb`。

所以在某个数据库的子目录下，有：

```
-rw-r-----. 1 root mysql   61 1月   6 01:22 db.opt
-rw-r-----. 1 root mysql 8.5K 1月   6 01:22 user.frm
-rw-r-----. 1 root mysql  96K 1月   6 01:33 user.ibd
```

`user.ibd`存储的就是`user`表中的数据和索引。

我们还可以自己指定使用`系统表空间`还是`独立表空间`来存储数据：

```ini
[server]
innodb_file_per_table=0
```

这个参数值为0，代表使用系统表空间，当`innodb_file_per_table`为1，表示使用独立表空间，但是这个参数只对新建的表起作用。

如果想把已经存放在系统表空间中的表转移到「独立表空间」可以使用下面的语法：

```sql
alter table 表名 tablespace [=] innodb_file_per_table;
```

或者把已经存在「独立表空间」的表转移到「系统表空间」，可以使用：

```sql
alter table 表名 tablespace [=] innodb_system;
```

用`[]`中括号括起来的参数表示可有可无。

##### 其他类型的表空间

随着MySQL的发展，又出现了一些表空间：

-   通用表空间（general tablespace）
-   undo表空间（undo tablespace）
-   临时表空间（temporary tablespace）



#### 8.3.4 MyISAM存储表数据的方式

在`MyISAM`中索引全部都是`二级索引`，该存储引擎的「数据」和「索引」是分开放的。所以文件系统中需要使用不容的文件来存储数据文件和索引文件。

与InnoDB不同，MyISAM并不存在所谓「表空间」，表数据都存放在「对应的数据库子目录下」，也就是都是「独立表空间」。创建一个test表，在数据库子目录下有三个子文件：

```txt
test.frm
test.MYD
test.MYI
```

其中`test.MYD`代表数据文件，也就是我们插入的用户记录；`test.MYI`代表表的「索引文件」。



#### 8.3.5 视图在文件系统中的表示

在MySQL中，「视图」就是虚拟的表，所以存储视图的时候不需要存储真实数据，只需要存储结构，也就是`视图名.frm`文件。



#### 8.3.6 其他文件

除了上述用户自己存储的数据外，`数据目录`下还包括了更好运行程序的一些额外文件：

-   服务器进程文件

    每运行一个MySQL服务器程序，都意味着启动一个进程，MySQL服务器会把自己的进程ID写入到一个文件中

-   服务器日志文件

-   默认/自动 生成的SSL和RSA证书和密钥文件



### 8.4 文件系统对数据库的影响

