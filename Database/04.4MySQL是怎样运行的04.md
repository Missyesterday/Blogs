# MySQL 是怎样运行的 04

## 19. 事务简介

### 19.1 事务的起源

我们想让某些数据库操作符合现实世界中状态转换的规则：也就是所谓「ACID」。

以转账为例，转账分为两步：

1.   扣钱
2.   加钱

#### 19.1.1 原子性（Atomicity）

现实生活中转账是一个不可分割的操作，要么全做，要么全不做，这种规则被称为「原子性」。

#### 19.1.2 隔离性（Isolating）

假设 A 的值为 11，B 的值为 2：

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230527115034693.png" alt="image-20230527115034693" style="zoom:50%;" />

执行两次转账之后，A 的值为 6，B 的值为 12，银行要亏钱了。

所以还需要保证「其他的状态转换不会影响到本次状态转换」，这个规则被称为「隔离性」。



#### 19.1.3 一致性（Consistency）

数据库中的数据要符合现实世界中的约束，例如身份证号不能重复，性别只能是男或女，我们说这些数据是符合「一致性」的。

保证数据库中数据的一致性（符合现实世界的所有约束），需要两方面努力：

-   数据库本身就能保证一部分一致性需求。例如使用主键、唯一索引，MySQL 还支持`check`语法来自定义约束：

    ```sql
    create table account(
        id int not null auto_increment comment '自增 id',
        name varchar(100) comment '客户名称',
        balance int comment '余额',
        primary key (id),
        check(balance >= 0)
    );
    ```

    但是 MySQL 仅仅支持`check`，但是在后续插入或更新数据的时候，MySQL 不会检查 check 子句中的约束是否成立。但是其他一些数据库例如 SQL Server 或者 Oracle 的 check 是实实在在起作用的，每次插入或更新都检查数据是否符合 check 子句中的约束条件是否成立，不成立就拒绝插入或更新。MySQL 可以使用触发器来自定义约束条件保证一致性。

-   更多一致性需求需要程序员自己保证

    在更改数据库时进行一致性检查是一个耗费性能的工作，有的一致性需求是很复杂的，业务等不起。



「原子性」和「隔离性」都会对「一致性」产生影响。



#### 19.1.4 持久性（Durability）

当现实世界的一个状态转换完成后，这个转换的结果将被永久保留，这个规则被称为「持久性」。数据库中实现持久性就是把修改的数据保存在磁盘上。



### 19.2 事务的概念

我们把需要保证「原子性」、「隔离性」、「一致性」和「持久性」的一个或多个数据库操作称为一个「事务」（transaction）。

「事务」是一个抽象的概念，它对应着一个或多个数据库操作，它有这几种状态：

-   活动的（active）：事务对应的数据库操作正在执行的过程中，该事务就处在`活动的`状态
-   部分提交的（partially committed）：当事务中的最后一个操作执行完成，但是由于操作都在内存中执行，所造成的影响并没有刷新到磁盘时，我们就说该事务处在`部分提交的`状态
-   失败的（failed）：当事务处在`活动的`或者`部分提交的`状态时，可能遇到了某些错误（数据库自身的错误、操作系统错误或者断电）而无法继续执行，或者人为停止当前事务的执行，我们就说该事务处在`失败的`状态
-   中止的（aborted）：如果事务执行了一部分而变为`失败的`状态，需要`回滚`，当`回滚`完毕时，我们就说该事务处在了`中止的`状态
-   提交的（committed）：当一个处在`部分提交的`状态的事务将修改过的数据都同步到磁盘上之后，我们就可以说该事务处于`提交的`状态

一个基本的事务状态图如下：

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230527121331984.png" alt="image-20230527121331984" style="zoom:50%;" />

只有当事务处于「提交」或者「中止」状态时，事务的生命周期才算结束。



### 19.3 MySQL 中事务的语法

