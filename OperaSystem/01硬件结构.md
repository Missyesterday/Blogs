# 01 硬件结构

## CPU Cache 内存和硬盘

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost2/操作系统/存储结构/存储器成本的对比.png" style="zoom:80%;" />

-   寄存器一次读一般在半个时钟周期内，大小一般是 8 个字节（64 位 CPU）。CPU 的时钟周期就是 `1/主频`，例如主频是 2GHz，时钟周期就是 0.5ns。
-   L1 高速缓存每个 CPU 核心都有，分为「指令缓存」和「数据缓存」，访问速度一般在 2~4 个时钟周期，大小一般为几十KB
-   L2 高速缓存同样每个 CPU 核心都有，大小在几百 KB，速度大约是十个时钟周期
-   L3 高速缓存是多个 CPU 核心共用的，大小在几十 MB 左右，速度大约是几十个时钟周期

**SRAM 和 DRAM**

-   SRAM：Static Random-Access Memory，静态随机存取内存，只要不断电，数据就会一直保存
-   DRAM：Dynamic Random-Access Memory，动态随机存取内存，需要「定时刷新电容」，才能保证数据不丢失，内存速度大约在 200 时钟周期左右。



## 中断

中断是异步的，指的是中断处理程序与 CPU 当前执行流之间是异步的关系，不必等待中断处理程序执行完后就能继续当前 CPU 的执行流。

如果 CPU 检测到多个终端请求的话，会选择中断「优先级高」的中断来处理。中断的引入，是为了支持 CPU 和设备之间的「并行操作」，异常的引入是表示 CPU 执行指令时本身出现了问题。

中断是异步的，是指所有中断来的信号都记录在「中断寄存器」中，CPU 在「执行完一道指令之后」，会检查中断寄存器中有没有中断，如果有中断，就会选择一个中断优先级高的中断先处理。

而异常是同步的，是指异常发生的时候，CPU 立即处理本次异常，直到异常处理结束之后才继续接下来的任务。通俗一点的将就是：中断异步就是我可以不用立即处理，而是等执行完一条指令时候才可能处理，异常同步是指出了异常必须立马处理。

### 硬中断

硬中断就是外设自动产生的，用来通知系统 外设状态的变化，例如按下键盘和网卡收到数据。常说的「中断」一般指「硬中断」。

### 软中断

中断肯定是越快处理越好，Linux 为了实现这个要求，将中断过程分为了两个阶段，分别上是「上半部分」和「下半部分」。

-   **上半部分用来快速处理中断**，一般会暂时关闭中断你请求，主要负责「跟硬件紧密相关」或者「时间敏感」的事情。也就是硬中断。
-   **下半部分用来延迟处理上半部分未完成的工作。**一般以「内核线程」的方式运行。也就是「软中断」。



**例如：**网卡收到网络包后，通过 DMA 方式将接收到的数据写入内存，接着会通过**硬件中断**通知内核有新的数据到了，于是内核就会调用对应的中断处理程序来处理该事件，这个事件的处理也是会分成上半部和下半部。

上部分要做的事情很少，会先禁止网卡中断，避免频繁硬中断，而降低内核的工作效率。接着，内核会触发一个**软中断**，把一些处理比较耗时且复杂的事情，交给「软中断处理程序」去做，也就是中断的下半部，其主要是需要从内存中找到网络数据，再按照网络协议栈，对网络数据进行逐层解析和处理，最后把数据送给应用程序

>   除了「硬件设备处理程序的下半部分之外」，一些内核自定义事件也属于软中断，例如：内核调度、RCU 锁等。

所以说，软中断分为两种：

-   硬中断的下半部
-   内核自定义事件
