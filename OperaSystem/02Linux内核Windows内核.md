# Linux 内核

## 内核简介

**内核就是 应用 连接 硬件 的桥梁：**

这样应用程序只需要和内核交互，而不用关心硬件的细节。

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230826161638581.png" alt="image-20230826161638581" style="zoom:50%;" />

## 内核的能力

内核一般都有的四个基本能力：

-   **进程调度**。管理进程、线程，决定哪个进程、线程使用 CPU
-   **内存管理**。决定内存的分配和回收
-   **硬件通信。**为进程和硬件之间提供通信能力
-   **提供系统调用。**如果应用程序需要更高权限运行的服务，那么就需要「系统调用」。「系统调用」是用户程序与操作系统之间的接口。



## 内核空间和用户空间

内核（可以理解为一个特殊的应用程序）具有很高的权限，例如：**控制 CPU、内存、硬盘**等硬件。而应用程序具有的权限很小，因此大多数操作系统，把内存分为了两个区域：

-   用户空间：给应用程序使用
-   内核空间：只有内核程序可以访问

用户空间的代码只能访问一个局部的内存空间，而内核空间的代码（不是普通程序员写的代码）可以访问所有的内存空间。

当一个程序使用用户空间时，这个程序在「**用户态**」执行；当一个程序使用内核空间时，这个程序在「**内核态**」执行。应用程序进入内核空间，需要通过「**系统调用**」（也就是内核提供的接口）：



<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E6%A0%B8/systemcall.png" alt="img" style="zoom:70%;" />

内核程序执行在内核态，用户程序执行在用户态。当用户程序使用系统调用，会产生一个「软中断」，CPU 会跳转到「中断处理程序」，开始执行内核程序，内核处理完成后，主动触发中断，把 CPU 执行权限交给用户程序，回到用户态继续工作。

## 宏内核

宏内核（Monolithic Kernel），意思是巨大的内核，而不是 C++的宏。Linux 的架构就是宏内核，意味着Linux 内核是一个完整的可执行程序，且拥有最高的权限。

下图分别是：宏内核、微内核、混合内核

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost4@main/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E5%86%85%E6%A0%B8/OS-structure2.png" alt="分别为宏内核、微内核、混合内核的操作系统结构" style="zoom:40%;" />

### 宏内核的特征

**系统的所有模块，包括 进程调度、内存管理、文件系统、设备驱动 都运行在内核态。**



### 微内核的特征

微内核架构的内核只保留了最基本的能力，例如：进程调度、虚拟内存、中断等，把一些应用放到了用户空间，例如驱动程序、文件系统等，这样服务与服务之间是隔离的，单个服务出现故障不会影响其他服务，提高了操作系统的稳定性和可靠性。

### 混合类型内核的特征

内核里面会有一个最小版本的内核，然后其他模块会在这个基础上搭建，然后实现的时候会跟宏内核类似，也就是把整个内核做成一个完整的程序，大部分服务都在内核中，这就像是宏内核的方式包裹着一个微内核。