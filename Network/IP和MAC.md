# IP 和 MAC

## 远程定位-IP

TCP需要 IP 模块将数据封装成「网络包」发送给通信对象。

IP 报文头格式：

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230905230636021.png" alt="image-20230905230636021" style="zoom:30%;" />

-   源IP地址：客户端输出的 IP 地址，多个网卡条件下，查「路由表」来决定
-   目的 IP 地址：通过 DNS 域名解析得到的 Web 服务器的 IP
-   TCP 的版本协议号为`0x06`



**路由表：**

-   目的地址（一般是网络地址，而不是 IP 地址，主机位为 0）
-   网关（下一跳地址），也是路由器的地址
-   目的地址的子网掩码
-   Iface：网卡名字

>   所有网络都有一个边界，限制与直接连接到它的设备的通信。因此，如果网络想要与该边界之外的设备，节点或网络通信，则它们需要网关的功能。网关通常被表征为路由器和调制解调器的组合。
>
>   在传统TCP/IP术语中，网关(gateway)与路由器(router)没有区别。



## 两点定位-MAC

生成 IP 头之后，还需要加上 MAC 头：

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230905231903978.png" alt="image-20230905231903978" style="zoom:50%;" />

-   发送方 MAC 地址和接收方 MAC 地址用于「两点之间」的传输（不经过路由器）

    网卡的 MAC 地址是固定的，而接收方的 MAC 地址也就是下一跳的 MAC 地址（也就是网关的 MAC地址)需要 ARP 协议

-   协议类型：`0800`：IP,`0806`：ARP 协议



### ARP 协议

通过查路由表，我们是知道网关的 IP 地址，此时ARP 协议在以太网中以「广播」的形式发送请求，路由器收到后会将自己的 MAC 地址发送给主机，同时发送方会有「ARP 缓存」。

这样 MAC 报文就生成了。

## 出口-网卡

网卡会在网络包前后加上报头和检测错误用的「帧校验序列」，并将包转为电信号发送出去。

## 送别者-交换机

交换机的设计是「将网络包」**原样**转发到目的地。交换机工作在 MAC层，也就是**二层网络设备**。

>   交换机：工作在数据链路层，原理等同于多端口网桥。作用是连接数个相同网段的不同主机，减少网内冲突，隔离冲突域。利用存储转发和过滤技术来从物理上分割网段。交换机连接的是同一个网络，把几台主机连到一起。
>
>   就我实习的经验而言，交换机，就是把几个电脑接到这上面，然后这几台电脑就可以通信了，如果把路由器的网线连上，那么这几台电脑都可以连接上路由器。

交换机有 MAC 地址表，存放的是 MAC 地址和对应的物理端口：

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230905233813269.png" alt="image-20230905233813269" style="zoom: 33%;" />

### 当 MAC 地址表中找不到指定的 MAC 地址

理论上来说这好像不太可能的，此时交换机会把这个包发送给所有的端口，如果不是你的包，则设备会忽略。如果是广播地址，则 MAC 地址是：`FF:FF:FF:FF:FF:FF`。



## 出境大门-路由器

路由器是基于 IP 设计的，也叫「三层网络设备」，路由器的每个端口都有「MAC地址」和「IP 地址」。

路由器会先检查 MAC头部的 MAC 地址，看是不是自己的包，如果是，则丢弃 MAC 头部，

路由器有路由表：会检查 IP 地址，然后通过对应的接口发送（不同的接口的 MAC 地址不同，类似于多张网卡）。

接下来根据网关判断对方的地址：

-   如果网关是 IP 地址，则证明还需要转发，转发的地址就是「网关地址」。
-   如果网关是「空」，则证明 IP 头中的「接收方 IP 地址」就是要转发的地址，也就是说这个IP 地址在这个路由器的子网内。

知道对方的 IP 地址后，还需要 ARP 协议根据 IP 地址查询 MAC 地址，并将查询的结果作为接收方的 MAC 地址。



>   容易混淆的一个点：
>
>   -   查路由表可以知道下一跳去哪，但是这个地址不会写到IP 协议头的地方，而是通过 ARP 协议，找到对应的 MAC地址，写入 MAC 包头。