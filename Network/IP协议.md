# IP协议

## IP基本认识

IP在TCP/IP模型中，处于第三层网络层。

网络层的主要作用是：实现主机和主机之间的通信，也就是点对点（end to end）通信。

### 网络层和数据链路层

也就是IP和MAC之间的区别。

IP是主机之间通信的，而MAC则是实现「直连」的两个设备之间通信，而IP则负责在「没有直连」的两个网络之间进行通信传输。



<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/3.jpg" style="zoom: 67%;" />

其实，在网络中数据包传输中也是如此，源IP地址和目标IP地址在传输过程中是不会变化的（前提：没有使用 NAT 网络），只有源 MAC 地址和目标 MAC 一直在变化。



## IP地址基础知识

在TCP/IP网络通信时，为了保证正常的通信，每个设备都需要配置正确的IP地址，否则无法实现正常的通信。

IPv4地址由32位正整数表示，IP地址在计算机是以二进制方式进行处理的。

「点分十进制」可以帮助记忆IPv4地址：

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/4.jpg" style="zoom:67%;" />

也就是说，最大允许「2^32=43亿」台计算机连接到网络。每个网卡有一个IP地址，如果一台设备，如服务器、路由器有两个以上网卡，也就是有2个以上IP地址。



<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/6.jpg" style="zoom:50%;" />

>   但是显然现在的设备数量超过了43亿，针对这个问题，有一种可以更换IP地址的技术`NAT`，使得可以连接的计算机数量超过43亿台。



### IP地址的分类

在互联网诞生之初，IP地址十分充足，所以计算机科学家设计了「分类地址」。

IP地址分为5种类型，分别是A类、B类、C类、D类、E类。它们的二进制IP地址的开头分别是「0、10、110、1110、1111」，类似于哈夫曼编码，这些开头的二进制数也被称为「分类号」。



<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/7.jpg" style="zoom:67%;" />

对于A、B、C三类地址，主要分为两个部分：「网络号和主机号」。



<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/8.jpg"  />

「最大主机数」 = 「2^主机号 - 2」，主机号全为1和全为0的地址是特殊的IP地址：

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/10.jpg)

-   主机号全为1指定某个网络下的所有主机，用于广播
-   主机号全为0指定某个网络

因此，在分配的过程中，需要去掉这两种情况

**广播地址的作用，也就是主机号全为1的地址：**

广播地址用于在「同一个**链路**中相互连接的主机之间发送数据包」。

当主机号全为 1 时，就表示该网络的广播地址。例如把 `172.20.0.0/16` 的网络地址，用二进制表示，同时将最后16位（主机号部分）改为1，就变成广播地址了。



**广播地址可以分为本地广播和直接广播：**

-   「在本网络内广播称为**本地广播**」。例如网络地址为`192.168.0.0/24`的情况下，广播地址是`192.168.0.255`。因为这个广播地址的IP包会被路由器屏蔽，所以不会到达`192.168.0.0/24`以外的其他链路上。
-   「在不同网络之间的广播称为**直接广播**」。例如网络地址为`192.168.0.0/24`的主机向`192.168.1.255/24`的目标地址发送IP包，收到这个包的路由器，将数据转发给`192.168.1.0/24`，从而使得所有`192.168.1.1~192.168.1.254`的主机都能收到这个包（由于直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发）

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/11.jpg" style="zoom:60%;" />

**关于D、E类地址：**

由于D类和E类地址没有主机号，所以不可以用为主机IP，D类常被用于「多播」，E类是预留的分类，暂时没有使用。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/12.jpg)



**多播地址：**

多播用于「**将包发送给特定组内的所有主机**」。

由于广播无法穿透路由，若想给其他网段发送同样的包，就可以使用穿透路由的多播。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/13.jpg" style="zoom:67%;" />



IP分类的优点是：容易分辨A、B、C类地址。

IP分类的缺点：

-   **同一个网络下没有地址层次，**比如一个公司用B类地址，但是需要划分地址层次，而这种IP分类没有地址层次划分的功能，缺少地址的灵活性
-   A类B类地址包含的最大主机数太多了，C类太少了。



### 无分类地址CIDR

因为IP分类存在许多问题，CIDR则是「无分类地址的方案」。

例如`a.b.c.d/x`，其中`x`表示前x位属于网络号，x的范围是`0~32`，这样IP地址就更加有灵活性。

例如`10.100.122.2/24`这种地址表示形式就是CIDR，前24位是网络号，剩下的8位是主机号。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/15.jpg" style="zoom:67%;" />



**子网掩码**是另一种划分网络号和主机号的形式，「掩码」的意思是掩盖掉主机号，剩余的就是网络号。



**为什么要区分网络号和主机号**

因为两台计算机要通讯，首先要判断是否处于同一个「广播域」内，也就是网络地址是否相同。如果网络地址相同，则表明接收方在本网络上，那么可以把数据包直接发送到目标主机。

路由器寻址工作时，也就是通过这样的方式来找到对应的网络号的，进而把数据包转发到对应的网络内。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/17.jpg" style="zoom:80%;" />

可以通过CIDR和子网掩码划分子网，子网划分的本质是将主机地址划分为两个部分：「子网网络地址和子网主机地址」。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/18.jpg)

-   未做子网划分的IP地址：网络地址+主机地址
-   做子网划分的IP地址：网络地址+子网网络地址+子网主机地址

做了子网划分后，也就有了新的广播地址和网络地址



### 公有IP地址和私有IP地址

在A、B、C分类地址，实际上有分公有IP地址和私有IP地址。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/22.jpg)

平时我们家里、办公室使用的IP地址，一般是私有IP地址。因为这些地址允许组织内部的IT人员自己管理、自己分配，**而且可以重复**，也就是说，你学校的某个私有 IP 地址和我学校的可以是一样的。

所以，公有 IP 地址是有个组织统一分配的，假设你要开一个博客网站，那么你就需要去申请购买一个公有 IP，这样全世界的人才能访问。并且公有 IP 地址基本上要在整个互联网范围内保持唯一。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/23.jpg)

私有IP地址由内部的IP人员管理，公有IP地址是由「ICANN」组织管理，中文叫「互联网名称与数字地址分配机构」。

IANA是ICANN的一个结构，它负责按州分配互联网IP地址，CNNIC则是中国国内唯一指定的全局IP地址管理的组织。



### IP地址与路由控制

IP地址的「网络地址」这一部分用于进行路由控制。

在主机和路由器上，都有一个「路由器控制表」，其中记录着网络地址和下一步应该发送至路由器的地址。

在发送IP包时，首先要确定IP包首部中的目标地址，再从「路由器控制表」中找到与该地址具有「相同**网络地址**」的「记录」，根据该记录将IP包转发给相应的下一个路由器。如果「路由器控制表」中存在多条相同网络地址的记录，就选择相同位数最多的网络地址，也就是「**最长匹配**」。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/25.jpg)

-   主机A要发送一个IP包给主机B
-   首先在主机A的路由表中寻找IP为`10.1.2.10`相同的「网络地址」，没有找到则发送给默认路由器。



环回地址是在**同一台计算机上的程序之间网络通信**时所使用的一个默认地址，可以是`127.0.0.1`或者`localhost`，使用这个IP或主机名时，数据包不会流向网络。



### IP分片与重组

每种数据链路的最大传输单元`MTU`都是不同的，例如FDDI数据链路MTU是4352，以太网的MTU是1500字节等。

最常见的数据链路是以太网，它的MTU是1500字节。

当IP数据包大于MTU时，IP数据报就会被分片，经过分片之后的IP数据报在被重组的时候，只能由目标主机进行，路由器是不会进行重组的。

在分片传输中，一旦某个分片丢失，则会造成整个IP数据报作废，所以TCP引入了MSS，也就是在TCP层进行分片，而不是IP层，而对于UDP，也是尽量不要发送一个大于MTU的数据报文。



### IPv6基本认识

32位的IPv4大约可以提供42亿个地址，但早在2011年IPv4地址就已经被分配完了。

IPv6是128位的，还有更好的安全性和扩展性，但是IPv4和IPv6不能兼容，所以除了电脑手机之类的支持之外，还需要网络运营商对现有的设备进行升级。



**IPv6的亮点**

-   IPv6可自动配置，即使没有DHCP服务器可以实现自动分配IP地址，即插即用
-   IPv6包头首部长度采用固定的40字节，去掉了包头校验和，简化了首部接收，减轻了路由器的负荷，提高了传输的性能
-   IPv6由应对伪造IP地址的网络安全功能，以及防止线路窃听的功能，提升了安全性。



**IPv6的标识方式**

-   IPv6是128位，每16位位一组，每组用`:`冒号隔开
-   如果出现连续0的时候，可以将这些0全部省略，用两个`::`冒号隔开，但是一个IPv6地址中，只允许出现一次两个连续的冒号（因为多了会有二义性）。



**IPv6地址的结构**

IPv6类似IPv4，也是通过IP地址的前几位标识IP地址的种类。

IPv6的地址主要有以下类型地址：

-   单播地址：用于一对一的通信
-   组播地址：用于一对多的通信
-   任播地址，用于通信最近的节点，最近的节点是由路由协议决定
-   没有广播地址

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/29.jpg" style="zoom:50%;" />

### IPv4首部和IPv6首部

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/31.jpg)

IPv6相比于IPv4:

-   **取消了首部校验和字段，**因为在数据链路层和传输层都会校验，因此IPv6直接取消了IP的校验
-   **取消了分片/重新组装相关字段，**分片和重组非常耗时，IPv6不允许在中间路由器进行分片和重组，这种操作只允许在源和目标主机，提高路由器转发速度
-   **取消选项字段，**但是并没有消失，而是可能出现在`Next Header`「下一个首部」字段上



## IP协议相关技术

### DNS

我们在上网的时候，通常使用的是「域名」，而不是「IP地址」，因为前者方便人类记忆。

DNS域名解析可以将「域名网址自动转换为具体的IP地址」。

DNS中的域名都是用`.`来分割，越靠右的位置表示层级越高。



![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/32.jpg)

根域的DNS服务器信息保存互联网所有的DNS服务器中，这样，任何DNS服务器都可以找到并访问根域DNS服务器了。

因此客户端只要能找到任意一台DNS服务器，就可以通过它找到根域的DNS服务器，然后就可以一路向下找到位于下层的某台目标DNS服务器。



**域名解析的工作流程：**

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/33.jpg)

-   假设要访问`www.server.com`网址，浏览器首先查看一下自己的缓存里有没有，没有就想操作系统的缓存要，还没就检查本机域名解析文件`host`，如果还是没有，则会向DNS服务器进行查询。
-   客户端发送一个DNS请求，询问`www.server.com`的IP是多少，并发送给本地DNS服务器，也就是客户端的TCP/IP设置中填写的DNS服务器地址。例如macOS可以修改本地DNS：[https://support.apple.com/zh-cn/guide/mac-help/mh14127/mac](https://support.apple.com/zh-cn/guide/mac-help/mh14127/mac)
-   本地域名服务器收到客户端的请求后，先在自己的缓存表格中查找`www.server.com`的IP地址，有就直接返回IP地址。如果没有，本地DNS服务器会询问它的**根域名服务器**。根域名服务器是最高层次的，它不能直接用于域名解析，而是「指明一条道路」。
-   根DNS收到来自本地DNS的请求后，发现最后是`.com`，于是告诉本地DNS服务器`.com`顶级域名服务器的地址
-   本地DNS收到顶级域名服务器的地址后，就去问`.com`顶级域名服务器
-   这样依次往返，最终本地DNS将IP地址返回客户端，客户端和目标建立连接。

**DNS域名解析的过程，只指路，不带路。**

### ARP协议

在传输一个IP报文的时候，确定了源IP地址和目的IP地址后，就会通过主机「路由表」确定IP数据包下一跳， 然而，网络层的下一层是数据链路层，所以我们还需要「下一跳」的MAC地址。

由于主机路由表中可以找到下一跳的IP地址，所以可以通过「**ARP协议**」来求得下一跳的MAC地址。

**ARP是如何知道对方的MAC地址呢？**

ARP是借助「ARP请求」和「ARP响应」两种类型的包确定MAC地址的。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/34.jpg)

-   主机会通过**广播发送ARP请求**，这个包中包含了想要知道的MAC地址的主机IP地址
-   当同个链路中所有设备收到ARP请求时，会去拆开ARP请求包里的内容，如果ARP请求包中的目标地址和自己的IP地址一致，那么这个设备就将自己的MAC地址塞入ARP响应包返回给主机。

操作系统通常会把第一次通过ARP获取的MAC地址缓存起来，以便下次直接从缓存中找到对应IP地址的MAC地址。不过这个缓存是有时间限制的，超过时间限制，缓存的内容将被清除。



### RARP协议

ARP协议是已知IP地址求MAC地址，而RARP协议正好相反，它是「已知MAC地址，求IP地址」。例如将打印机服务器等小型嵌入式设备接入到网络时就经常会用得到。

通常这需要架设一台`RARP`服务器，在这个服务器上注册设备的MAC地址以及IP地址，然后再将这个设备接入到网络，接着：

-   该设备发送一条「我的MAC地址是XX，我的IP地址应该是什么」的请求信息
-   RARP服务器接收到这个消息后返回「MAC地址为XX的设备，IP地址为XXXX」的信息给这个设备

最后，设备就根据从RARP服务器所收到的「应答信息」设置自己的IP地址。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/35.jpg)

### DHCP协议

DHCP在生活中非常常见，我们的电脑通常都是通过DHCP动态获取IP地址，大大省去了配置IP信息的繁琐过程。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/36.jpg" style="zoom:67%;" />



首先，DHCP客户端进程监听的是68端口号，DHCP服务端进程监听的是67端口号。

DHCP客户端就是我们使用的电脑，它通过4个步骤，获取到自己的IP：

1.   客户端首先发起「**DHCP发现报文**」（DHCP DISCOVER）的IP数据报，由于客户端没有IP地址，也不知道DHCP服务器的地址，所以使用的是「**UDP广播通信**」，其使用的广播目的地址是`255.255.255.255:67`，端口号是67，并使用`0.0.0.0:68`作为源IP地址。DHCP客户端将该「IP数据报」传递给数据链路层，数据链路层然后将帧广播到所有的网络中设备。
2.   DHCP服务器收到「DHCP发现报文」时，用「**DHCP提供报文**」（DHCP OFFER）向客户端作出响应。该报文仍然使用IP广播地址`255.255.255.255`，该报文携带「服务器提供可租约的IP地址、子网掩码、默认网关、DNS服务器以及**IP地址租用期**」。
3.   客户端收到一个或多个服务器的「DHCP提供报文」后，从中选择一个服务器，并向选中的服务器发送「**DHCP请求报文**」（DHCP REQUEST）进行响应，回显配置的参数。
4.   最后，服务器用「**DHCP ACK报文**」对「DHCP请求报文」进行响应，应答所要求的参数。

一旦客户端收到DHCP ACK后，交互便完成了，并且客户端能够在租用期内使用DHCP服务器分配的IP地址。

**如果租约的DHCP IP地址快过期后，**客户端会向服务器发送DHCP请求报文：

-   服务器如果同意继续租用，则用DHCP ACK报文进行应答，客户端就会延长租期。
-   服务器如果不同意继续租用，则用DHCP NACK报文，客户端就要停止使用租约的IP地址。

可以发现，DHCP交互中，**全程使用的都是UDP广播通信。**这样就有了一个新问题，如果DHCP服务器和客户端不在同一个局域网内，路由器又不会转发广播包，那每个网络都要配置一个DHCP服务器吗？

为了解决这个问题，就出现了「**DHCP中继代理**」。有了「DHCP中继代理」之后，对不同网段的IP地址分配也可以由一个DHCP服务器进行统一管理。

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/37.jpg" style="zoom:50%;" />

-   DHCP客户端会向「DHCP中继代理」发送DHCP请求包，「DHCP中继代理」收到这个广播包之后，再以**单播**的形式发送给DHCP服务器。
-   服务器收到该包以后再向「DHCP中继代理」返回应答，并由「DHCP中继代理」将此包广播给「DHCP客户端」。

因此，DHCP服务器和客户端即使不在同一个链路上也可以实现统一分配和管理IP地址。

### NAT（网络地址转换）

IPv4的地址是非常紧缺的，「**网络地址转换NAT**」可以缓解IPv4地址耗尽的问题。

简单来说，NAT就是同个公司、家庭、教室内的主机对外部通信的时候，把私有IP地址转换成公有IP地址。

>   难道每个私有IP地址都要转换成唯一的公有IP地址吗？这样一一对应的关系，就代表着有多少个私有IP地址，就要有多少个公有IP地址，这显然没什么用。
>
>   按照设想，应该是多个私有IP地址对应一个公有IP地址，这样才可以缓解IP地址的紧缺，但是这样又有问题，怎么通过公有IP地址找到它对应的多个私有IP地址呢？

**答案是：将「IP地址+端口号」一起进行转换**

这种地址转换技术叫「网络地址与端口转换NAPT」，由于绝大多数网络应用都是使用传输层协议TCP或UDP来传输数据的，所以这种方法是可行的。

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/39.jpg)

可以看到，有两个客户端向服务器发起通信，这两个客户端的私有IP地址和端口是`192.168.1.10:1025`和`192.168.1.11:1025`，服务器的地址是`183.232.231.172:80`。

此时两个私有IP地址都转换为同一个公有IP地址`120.229.175.121`，**但是端口号不同用来区分。**在NAT路由器上生成一个「NAPT路由器转换表」，就可以正确的转换地址和端口，另客户端A、B能同时和服务器通信。

这个转换表在「NAT路由器」上自动生成。例如在TCP连接的情况下，建立TCP连接首次握手时的SYN包一发出，就生成这个表，随着收到「关闭连接FIN包」就删除。



**NAT/NAPT的缺点：**

NAT/NAPT的缺点来源于「转换表」：

-   外部无法主动与NAT内部服务器建立连接，因为NAPT转换表没有记录
-   转换表的生成和转换操作都会有性能开销
-   通信过程中，如果NAT服务器重启了，所有的TCP连接都将被重置

**如何解决**

-   改用IPv6，但是还需要一段时间普及

-   **NAT穿透技术**

    NAT穿透：在NAT穿透技术中，主机会主动发现自己发送的数据包会被NAT设备修改，于是它主动配合NAT是设备的操作，主动建立映射，这样就不需要由NAT设备来建立映射了。

    客户端主动从NAT设备获取公有IP地址，然后自己建立端口映射条目，直接使用这个条目对外通信，就不需要NAT设备来转换了。



### ICMP协议

ICMP，全称是「**Internet Control Message Protocol**」，也就是「**互联网控制报文协议**」。

「控制」这这个协议的关键字。网络包在复杂的网络传输环境中，经常会遇到各种问题。当遇到问题时，需要传出消息，报告遇到了什么问题。

**ICMP功能：**

-   确认IP包是否成功送达目的地
-   报告发送过程中IP包被废弃的原因
-   改善网络设置
-   等等

在IP通信中，如果某个IP包因为某种原因未能到达目的地址，那么这个具体的原因将由ICMP负责通知：

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/40.jpg" style="zoom:67%;" />

上图中，主机A向主机B发送了数据包，由于主机B电源关闭，路由器2未能发现主机B的存在。此时路由器2就会向主机A发送一个「ICMP目标不可达数据包」，说明发往主机B的包失败。

ICMP这种通知消息会用IP进行发送。



**ICMP大致可以分为两大类：**

-   「查询报文类型」，用于**诊断**
-   「差错报文类型」，用于**通知出错原因**

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/41.jpg" style="zoom:67%;" />



### IGMP协议

首先，IGMP和ICMP没有任何关系。

IGMP是「因特网组管理协议」，工作在主机（组播成员）和最后一跳路由之间，如下图蓝色部分：

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/IP/42.jpg" style="zoom:67%;" />

D类地址（组播地址），是只有一组的主机能收到数据包，不在一组的主机不能收到数组包，怎么管理是否是在一组呢？这时就需要IGMP协议了。

-   IGMP报文向路由器申请「加入和退出组播」，默认情况下，路由器是不会转发组播包到连接中的主机，除非主机通过IGMP加入到组播组，主机申请加入到组播组时，路由器就会记录IGMP路由器表，路由器后续就会转发组播包到对应的主机了。
-   IGMP报文采用IP封装，IP头部的协议号为2，TTL字段通常为1，因为IGMP是工作在主机和连接的路由器之间



### ping命令

ping是基于ICMP协议工作的，ICPM包头如下：

<img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost/计算机网络/ping/5.jpg" style="zoom:50%;" />

ping命令执行的时候，源主机会构建一个「**ICMP回送请求消息**」数据包。

ICMP数据包最重要的两个字段：

-   **类型**，对于回送请求消息而言该字段为8
-   **序号**，主要区分连续ping的时候发出的多个数据包，每次发送一个请求数据包，「序号」都会加一。

然后，由ICMP协议将这个数据包连同目的IP地址一起交给IP层，IP层也加上目的地址和原地址信息，**协议**字段设置为1，表示是ICMP协议，再加上其他控制信息，构建一个IP数据包。

接下来，需要加入`MAC`头。如果在「本地ARP映射表」中查找出目的IP所对应的MAC地址，则直接使用这个MAC地址；如果没有，则需要发送`ARP`协议查询MAC地址，获得MAC地址后，由数据链路层构建一个数据帧，目的地址是IP层传过来的MAC地址，源地址是本机的MAC地址，还需要附加一些控制信息。



主机B收到这个数据帧后

## `127.0.0.1`和`0.0.0.0`和`localhost`的区别

### 什么是`127.0.0.1`

首先，拔掉网线，然后`ping 127.0.0.1`，是可以ping通的。

**127开头的IP地址都属于「回环地址」**，也是IPv4的特殊地址，是人为规定的。

而`127.0.0.1`是众多回环地址中的一个。在IPv6下，回环地址是`::1`，中间把连续的0省略了，注意IPv6地址最多出现两个连续的`:`冒号。

在IPv6下，`ping`命令为：

```shell
ping6 ::1
```

### 什么是ping

ping是应用层命令，ping作为一个小工具，它的功能比较简单，就是**尝试**发送一个小小的消息到目标及其上，判断目的及其是否可达，也就是判断目标机器的网络是否能联通。

ping应用的底层，用的是「网络层」的ICMP协议。

IP和ICMP和Ping所在分层不同。

虽然ICMP协议和IP协议都属于「网络层协议」，但其实ICMP协议也是利用了IP协议进行消息的传输。



### TCP发数据和ping的区别

一般情况下，我们会使用TCP进行网络数据传输，那么我们可以看下它和ping的区别：

<img src="https://raw.githubusercontent.com/Missyesterday/picgo/main/picgo/image-20230421223053339.png" alt="image-20230421223053339" style="zoom:50%;" />

ping和其他应用软件都属于「应用层」。本质上，ping和「普通应用发送消息」没有太大区别，所以怀疑网络有问题的的时候，通常第一时间想到ping，能ping通的话说明其他软件发送的数据包也能通。

### 断网ping 127.0.0.1

**先说答案：能ping通**。



<img src="https://cdn.xiaolincoding.com//mysql/other/c1019a8be584b27c4fc8b8abda9d3cf1.png" style="zoom:50%;" />

从应用层到传输层到网络层，这段路径和ping外网的时候几乎是一样的。到了网络层，系统会根据「目的IP」，在路由表中获取对应的「**路由信息**」，而这其中就包含选择哪个网卡把消息发出：

-   当发现目标IP是外网IP时，会从「真网卡」发出。
-   当发现目标IP是回环地址时，就会选择「本地网卡」。

所谓「本地网卡」，本质上是一个假网卡，它没有「真网卡」的`ring buffer`，而是把数据推到一个叫`input_pkt_queue`的链表中。这个链表，是所有网卡共享的，上面挂着发给本机的各种消息。消息被发送到这个链表后，会触发**软中断**。

`ksoftirqd`这个内核线程会处理软中断，它把消息从链表中取出，然后顺着数据链路层，网络层 层层向上传递到应用程序。

